#! /bin/bash

short_usage()
{
	echo `basename $0` [-basedir directory] [-release]
}

usage()
{
	short_usage;
	echo "-basedir directory"
	echo "  Set the directory where the AAF directory resides."
	echo "-release"
	echo "	Test the release build.  The default is debug."
	echo
	echo "Run the ComModAAF program for this platform and the specified build type."
	echo "The AAFTARGET environment variable may be used as an alternative to the"
	echo "-release option."
	exit 1;
}

BASE_DIR=.
AAFTARGET=${AAFTARGET:=Debug}

until [ $# == 0 ]
do

	case $1 in
		-basedir  ) BASE_DIR=$2 ; shift ;;
		-release  ) AAFTARGET=Release ;;
		-h        ) usage ;;
		-help     ) usage ;;
		*	  ) echo Unrecognized option $1 ; short_usage; exit 1 ;;
	esac

	shift
done

cd ${BASE_DIR}/AAF
if [ $? -ne 0 ]; then
    echo Failed to change to AAF directory: ${BASE_DIR}/AAF
    exit 1
fi

BUILD_DIR=`make builddir AAFTARGET=${AAFTARGET}`
cd $BUILD_DIR
if [ $? -ne 0 ]; then
    echo Failed to change to build directory: $BUILD_DIRECTORY
    exit 1
fi

case $AAFTARGET in 
	Debug   ) BIN_DIR=bin/debug ;;
	Release ) BIN_DIR=bin ;;
	* ) echo Unrecognized AAFTARGET value: $AAFTARGET; exit 1 ;; 
esac

cd $BIN_DIR
if [ $? -ne 0 ]; then
    echo Failed to change to binary directory: $BIN_DIR
    exit 1
fi

# Get the required Laser.wav file.
cp ${BASE_DIR}/AAF/AAFWinSDK/examples/com-api/ComEssenceDataTest/Laser.wav .
if [ $? -ne 0 ]; then
	echo Failed to copy Laser.wav.
	exit 1
fi

#
# Run the regression tests.
#
LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:. ./ComModAAF 

exit $?
