###############################################################################
#
# The contents of this file are subject to the AAF SDK Public
# Source License Agreement (the "License"); You may not use this file
# except in compliance with the License.  The License is available in
# AAFSDKPSL.TXT, or you may obtain a copy of the License from the AAF
# Association or its successor.
#
# Software distributed under the License is distributed on an "AS IS"
# basis, WITHOUT WARRANTY OF ANY KIND, either express or implied.  See
# the License for the specific language governing rights and limitations
# under the License.
#
# The Original Code of this file is Copyright 1998-2002, Licensor of the
# AAF Association.
#
# The Initial Developer of the Original Code of this file and the
# Licensor of the AAF Association is Avid Technology.
# All rights reserved.
#
###############################################################################

# Generate html tables containing change logs.
#
# Each table
#   - contains a log of the changes between two repository tags.
#   - is placed in its own file.
#
# Author : Tim Bingham " Tim_Bingham@avid.com
#

TOOLNAME=${0##*/}
TOOLPATH=${0%/${TOOLNAME}}

if [[ ${#} != 2 ]]
then
  echo "$TOOLNAME : Error wrong number of arguments (${#})."
  echo "$TOOLNAME : Usage : $TOOLNAME <tagdates> <colormap>"
  exit 1
fi

tagstufffile=${1}

if [[ ! -s $tagstufffile ]]
then
  echo "$TOOLNAME : Can't find tag dates \"${tagstufffile}\"."
  exit 1
fi

cmfile=${2}

if [[ ! -s $cmfile ]]
then
  echo "$TOOLNAME : Can't find color map \"${cmfile}\"."
  exit 1
fi

declare -a tagstuff
let i=0;
while read tag date time
do
  if [[ $tag != "#" ]]
  then
    tagstuff[i]=$tag
    tagstuff[i+1]=$date
    tagstuff[i+2]=$time
    let i=$i+3;
  fi
done < $tagstufffile

tagstuff[i]="head"
tagstuff[i+1]=""
tagstuff[i+2]=""

let n=${#tagstuff[@]}/3

let i=0
while [[ i -lt n ]]
do
  tagnames[i]=${tagstuff[i * 3]}
  tagdates[i]=${tagstuff[(i * 3) + 1]}" "${tagstuff[(i * 3) + 2]}
  let i=$i+1
done

#let i=0
#while [[ i -lt n ]]
#do
#  echo ${tagnames[i]} ${tagdates[i]}
#  let i=$i+1
#done

let i=1
while [[ i -lt n ]]
do
  ptag=${tagnames[i - 1]}
  tag=${tagnames[i]}
  pdate=${tagdates[i - 1]}
  date=${tagdates[i]}
  #echo $ptag $tag
  log=Changes-$ptag-$tag.log
  clog=Changes-$ptag-$tag.clog
  html=Changes-$ptag-$tag.html
  #echo $log
  #echo $clog
  #echo $html
  #
  # get the raw "cvs log" output
  #
  if [[ ! -f $log ]]
  then
    cvs -q log -d"${pdate}<${date}" > $log
  fi
  #
  # make the change log
  #
  if [[ ! -f $clog ]]
  then
    cat $log | ${TOOLPATH}/cvs2cl.pl --stdin --stdout > $clog
  fi
  #
  # convert the change log to html
  # 
  if [[ ! -f $html ]]
  then
    cat $clog | awk -v TAG1="$ptag" -v TAG2="$tag" -f ${TOOLPATH}/cl2html.awk ${cmfile} > $html
  fi
  #
  # next tag
  #
  let i=$i+1
done

date=$(date)
user=$(echo $USER)
computer=$(hostname)

index=Changes-index.html

echo "<!DOCTYPE html PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\">" > $index
echo "<!-- -->" >> $index
echo "<!-- This file was generated on ${date} by user ${user} -->" >> $index
echo "<!-- on system ${computer} using ${TOOLNAME} -->" >> $index
echo "<!-- If you edit this file your changes may be lost. -->" >> $index
echo "<!-- -->" >> $index

echo "<html>" >> $index
echo "<head>" >> $index
echo "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=ISO-8859-1\">" >> $index
echo "<title>Index of cvs change logs</title>" >> $index
echo "</head>" >> $index
echo "<body>" >> $index
echo "<h1 align=center>Index of cvs change logs</h1>" >> $index
echo "<ul>" >> $index

let i=$n-1
while [[ i -gt 0 ]]
do
 ptag=${tagnames[i - 1]}
 tag=${tagnames[i]}
 file=Changes-${ptag}-${tag}
 if [[ -s ${file}.clog ]]
 then
   echo "<li><a href=\"${file}.html\">${ptag} -> ${tag}</a>"
 else
   echo "<li>${ptag} -> ${tag} - no changes"
 fi
 let i=$i-1
done >> $index
echo "</ul>" >> $index
echo "</body>" >> $index
echo "</html>" >> $index
